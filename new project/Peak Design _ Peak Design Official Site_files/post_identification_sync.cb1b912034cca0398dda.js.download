"use strict";(self.webpackChunk_klaviyo_onsite_modules=self.webpackChunk_klaviyo_onsite_modules||[]).push([[7327],{80090:function(e,t,n){var r=n(69899),o=(n(56816),n(64994)),a=n(74882);const s="kl-post-identification-sync",i="kl-onsite-modules",c="kl-event-cache",l=JSON.stringify([]),d=()=>"indexedDB"in window,u={upgrade(e){e.objectStoreNames.contains(c)||e.createObjectStore(c,{autoIncrement:!0})}},p=async e=>{const t=(await(0,o.X3)(i,1,u)).transaction(c,"readwrite"),n=t.objectStore(c);(async(e,t=1)=>{const n=await e.getAll(),r=n.length+t-1e4;if(r>0)for(let t=0;t<r;t+=1){const{id:t}=n[0];try{e.delete(t)}catch(e){console.error("Error deleting record from indexedDB",e),e instanceof Error&&(0,a.T)(e,{tags:{source:"post-identification-sync",method:"asyncDeleteIfOverMaxRecords"}})}}})(n);const{time:r,name:s}=e;return n.add({event:e,time:r,name:s}),t.done},f=(e,t)=>{d()?p(e).finally((()=>{t&&t()})):(async e=>{const t=localStorage.getItem(s),n=null===t?[]:JSON.parse(t);n.push(e),n.length>1e4&&n.shift(),localStorage.setItem(s,JSON.stringify(n))})(e).finally((()=>{t&&t()}))},m=async(e=1e3)=>d()?(async e=>{const t=await(0,o.X3)(i,1,u),n=t.transaction(c,"readwrite").objectStore(c).openCursor(),r=[];let s,l=async()=>{};return await n.then((function n(o){if(o&&!(r.length>=e))return r.push(o.value.event),s=o.key,o.continue().then(n);s&&(l=()=>{const e=t.transaction(c,"readwrite").objectStore(c);let n=new Promise((()=>{}));try{n=e.delete(IDBKeyRange.upperBound(s))}catch(e){console.error("Error deleting records from indexedDB",e),e instanceof Error&&(0,a.T)(e,{tags:{source:"post-identification-sync",method:"getEventsAndDeleteCallbackFromIndexedDb#deleteCallback"}})}return n})})),{events:r||[],deleteCallback:l}})(e):(async e=>{const t=JSON.parse(localStorage.getItem(s)||l),n=t.slice(0,e),r=t.slice(e);return{events:n||[],deleteCallback:async()=>{localStorage.setItem(s,JSON.stringify(r))}}})(e),y=()=>d()?(async()=>(await(0,o.X3)(i,1,u)).transaction(c,"readwrite").objectStore(c).clear())():(async()=>{localStorage.removeItem(s)})(),h=(e,t)=>{var n;const r=(new Date).toISOString(),o={name:e.event,time:(null==(n=e.properties)?void 0:n.time)||r,properties:e.properties||{}};f(o,t)};var b=n(2116),g=n.n(b),v=n(44050),w=n(50040),k=n(28650),D=n(96497),I=n(113);const S=new Set(["$exchange_id","email","id","$email","$id","$anonymous","$phone_number"]),E=["name","properties"],B=`${v.bl.url}${v.bl.eventBulkCreate}`;let j=!1;const O=(e,t,n,r)=>{const o=((e,t,n)=>({data:{type:"event-bulk-create",attributes:{profile:{data:{type:"profile",attributes:Object.assign({},t),meta:{identifiers:t}}},events:{data:e.map((e=>{const{name:t,properties:r}=e,o=g()(e,E),a=Object.assign({},r,n||{});return{type:"event",attributes:Object.assign({metric:{data:{type:"metric",attributes:{name:t}}}},o,Object.keys(a).length>0?{properties:a}:{})}}))}}}}))(e,n,r);return(0,k.W)((()=>((e,t)=>fetch(`${B}/?company_id=${e}`,{method:"POST",headers:Object.assign({"Access-Control-Allow-Headers":"*","Content-Type":"application/json"},(0,w.h)(),{revision:"2023-10-15"}),body:JSON.stringify(t)}))(t,o)),5,1e3+1e3*Math.random(),[429])},C={$exchange_id:"_kx",email:"email",id:"id",$email:"email",$id:"id",$anonymous:"anonymous_id",$phone_number:"phone_number"},$=e=>{let t={};return Object.keys(C).forEach((n=>{if(r=n,Set.prototype.has.call(S,r)){const r=e[n];if(r){const e=("$email"===n||"email"===n)&&!(0,D.v)(r),o="$phone_number"===n&&!(0,I.y)(r);e||o||(t=Object.assign({},t,{[C[n]]:r}))}}var r})),t},_=(e,t,n,r)=>{if(0!==e.events.length)return O(e.events,t,n,r).then((async o=>{if(429===o.status)throw Error("Saving event cache due to rate limit.");return e.deleteCallback&&await e.deleteCallback(),m().then((e=>_(e,t,n,r)))}))},x=async(e,t,n,r)=>{const o=e||window.__klKey;if(!o||j)return;const a=$(t);a&&0!==Object.keys(a).length&&(j=!0,m().then((e=>_(e,o,a,n))).catch((e=>{throw console.error("Failed to send bulk events",e),e})).then((()=>{y(),r&&r()})).catch((e=>{console.error("Failed to clear storage",e)})).finally((()=>{j=!1})))};(()=>{(0,r.e)("cacheEvent",h),(0,r.e)("sendCachedEvents",x)})()},64994:function(e,t,n){n.d(t,{X3:function(){return y}});let r,o;const a=new WeakMap,s=new WeakMap,i=new WeakMap,c=new WeakMap,l=new WeakMap;let d={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return s.get(e);if("objectStoreNames"===t)return e.objectStoreNames||i.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function u(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(o||(o=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(m(this),t),f(a.get(this))}:function(...t){return f(e.apply(m(this),t))}:function(t,...n){const r=e.call(m(this),t,...n);return i.set(r,t.sort?t.sort():[t]),f(r)}}function p(e){return"function"==typeof e?u(e):(e instanceof IDBTransaction&&function(e){if(s.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",a),e.removeEventListener("abort",a)},o=()=>{t(),r()},a=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",a),e.addEventListener("abort",a)}));s.set(e,t)}(e),t=e,(r||(r=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>t instanceof e))?new Proxy(e,d):e);var t}function f(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",a)},o=()=>{t(f(e.result)),r()},a=()=>{n(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",a)}));return t.then((t=>{t instanceof IDBCursor&&a.set(t,e)})).catch((()=>{})),l.set(t,e),t}(e);if(c.has(e))return c.get(e);const t=p(e);return t!==e&&(c.set(e,t),l.set(t,e)),t}const m=e=>l.get(e);function y(e,t,{blocked:n,upgrade:r,blocking:o,terminated:a}={}){const s=indexedDB.open(e,t),i=f(s);return r&&s.addEventListener("upgradeneeded",(e=>{r(f(s.result),e.oldVersion,e.newVersion,f(s.transaction),e)})),n&&s.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),i.then((e=>{a&&e.addEventListener("close",(()=>a())),o&&e.addEventListener("versionchange",(e=>o(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),i}const h=["get","getKey","getAll","getAllKeys","count"],b=["put","add","delete","clear"],g=new Map;function v(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(g.get(t))return g.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=b.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!h.includes(n))return;const a=async function(e,...t){const a=this.transaction(e,o?"readwrite":"readonly");let s=a.store;return r&&(s=s.index(t.shift())),(await Promise.all([s[n](...t),o&&a.done]))[0]};return g.set(t,a),a}d=(e=>({...e,get:(t,n,r)=>v(t,n)||e.get(t,n,r),has:(t,n)=>!!v(t,n)||e.has(t,n)}))(d)}},function(e){e.O(0,[2462,7075],(function(){return t=80090,e(e.s=t);var t}));e.O()}]);